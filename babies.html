<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Growth Analysis with Plotly</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
      }
      .chart {
        width: 100%;
        height: 600px;
        margin-bottom: 3rem;
      }
      .controls {
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body>
    <h1>Growth Analysis</h1>
    <div class="controls">
      <label
        ><input type="radio" name="genderSelect" value="Male" /> Male
        Percentiles</label
      >
      <label
        ><input type="radio" name="genderSelect" value="Female" checked />
        Female Percentiles</label
      >
    </div>
    <div id="weightChart" class="chart"></div>
    <div id="lengthChart" class="chart"></div>
    <div id="bmiChart" class="chart"></div>

    <script>
      const csvFile = "data/size_tracking.csv";
      const percentiles = {
        Male: {
          weight: "data/weight_boys.csv",
          length: "data/length_boys.csv",
          bmi: "data/bmi_boys.csv",
          bmiExtra: [
            "P0.4 (Thinness 2)",
            "P4 (Thinness 1)",
            "P79 (Overweight)",
            "P97.5 (Obese)",
          ],
        },
        Female: {
          weight: "data/weight_girls.csv",
          length: "data/length_girls.csv",
          bmi: "data/bmi_girls.csv",
          bmiExtra: ["P1.6", "P10", "P89", "P99"],
        },
      };

      let currentGender = "Female";
      let weightTraces = [],
        lengthTraces = [],
        bmiTraces = [],
        maxAge = 0;

      function fetchCSV(url) {
        return fetch(url)
          .then((r) => r.text())
          .then(
            (t) => Papa.parse(t, { header: true, dynamicTyping: true }).data
          );
      }

      function buildPercentileTraces(
        referenceData,
        labelPrefix,
        field,
        extras = []
      ) {
        const base = ["P3", "P10", "P25", "P50", "P75", "P90", "P97"];
        const all = [...base, ...extras];
        const isWeight = field === "Weight (g)";
        return all.map((p) => ({
          x: referenceData.map((r) => r.Age),
          y: referenceData.map((r) => (isWeight ? r[p] * 1000 : r[p])),
          name: `${labelPrefix} ${p}`,
          mode: "lines",
          line: { dash: "dot" },
          hoverinfo: "name+y",
          type: "scatter",
        }));
      }

      async function plotCharts() {
        const weightPercentiles = buildPercentileTraces(
          await fetchCSV(percentiles[currentGender].weight),
          `${currentGender} Weight`,
          "Weight (g)"
        );
        const lengthPercentiles = buildPercentileTraces(
          await fetchCSV(percentiles[currentGender].length),
          `${currentGender} Length`,
          "Length (cm)"
        );
        const bmiPercentiles = buildPercentileTraces(
          await fetchCSV(percentiles[currentGender].bmi),
          `${currentGender} BMI`,
          "BMI",
          percentiles[currentGender].bmiExtra
        );

        Plotly.newPlot("weightChart", [...weightTraces, ...weightPercentiles], {
          title: "Weight vs Age by Individual",
          xaxis: { title: "Age (days)", dtick: 365 },
          yaxis: { title: "Weight (g)" },
        });

        Plotly.newPlot("lengthChart", [...lengthTraces, ...lengthPercentiles], {
          title: "Length vs Age by Individual",
          xaxis: { title: "Age (days)", dtick: 365 },
          yaxis: { title: "Length (cm)" },
        });

        Plotly.newPlot("bmiChart", [...bmiTraces, ...bmiPercentiles], {
          title: "BMI vs Age by Individual",
          xaxis: { title: "Age (days)", dtick: 365 },
          yaxis: { title: "BMI" },
        });
      }

      async function main() {
        const raw = await fetchCSV(csvFile);
        const data = raw.filter((r) => r["Age (days)"] != null);

        const byName = {};
        data.forEach((row) => {
          const name = row.Name;
          const gender =
            name === "Aita" || name === "Pojke"
              ? "Male"
              : name === "Mamma" || name === "Flicka"
              ? "Female"
              : "Unknown";
          row.Gender = gender;
          if (!byName[name]) byName[name] = [];
          byName[name].push(row);
          if (row["Age (days)"] > maxAge) maxAge = row["Age (days)"];
        });

        weightTraces = [];
        lengthTraces = [];
        bmiTraces = [];

        for (const name in byName) {
          const group = byName[name].sort(
            (a, b) => a["Age (days)"] - b["Age (days)"]
          );

          weightTraces.push({
            x: group
              .filter((p) => p["Weight (g)"] != null)
              .map((p) => p["Age (days)"]),
            y: group
              .filter((p) => p["Weight (g)"] != null)
              .map((p) => p["Weight (g)"]),
            mode: "lines+markers",
            name: name,
            type: "scatter",
          });

          lengthTraces.push({
            x: group
              .filter((p) => p["Length (cm)"] != null)
              .map((p) => p["Age (days)"]),
            y: group
              .filter((p) => p["Length (cm)"] != null)
              .map((p) => p["Length (cm)"]),
            mode: "lines+markers",
            name: name,
            type: "scatter",
          });

          bmiTraces.push({
            x: group
              .filter((p) => p["BMI"] != null)
              .map((p) => p["Age (days)"]),
            y: group.filter((p) => p["BMI"] != null).map((p) => p["BMI"]),
            mode: "lines+markers",
            name: name,
            type: "scatter",
          });
        }

        await plotCharts();
      }

      document.querySelectorAll('input[name="genderSelect"]').forEach((el) => {
        el.addEventListener("change", async (e) => {
          currentGender = e.target.value;
          await plotCharts();
        });
      });

      main();
    </script>
  </body>
</html>
